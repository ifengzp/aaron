---
title: 跨域
tags:
---

同源是指"协议+域名+端口"三者相同，它限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互。这是一个用于**隔离潜在恶意文件**的重要安全机制，如果缺少了同源策略，浏览器很容易搜到XSS、CSFR攻击等等。
<!-- more -->

## **同源策略限制以下几种行为**

- Cookie、LocalStorage和IndexDB无法读取
- DOM和Js对象无法获得
- AJAX请求不能发送

## 场景的跨域场景
| 例子 | 场景 | 可否通信 |
| -| - | - |
| http://www.baidu.com/a.js </br> http://www.baidu.com/b.js </br> http://www.baidu.com/lab/c.js | 同一域名，不同文件或者路径 | 允许 |
| http://www.baidu.com:8888/a.js </br> http://www.baidu.com/b.js | 同一域名，不同端口 | 不允许 |
| https://www.baidu.com/a.js </br> http://www.baidu.com/b.js | 同一域名，不同协议 | 不允许 |
| http://www.baidu.com/a.js </br> http://192.168.1.1/b.js | 域名和域名对应相同的ip | 不允许 |
| http://www.baidu.com/a.js </br> http://baidu.com/b.js | 主域相同，子域不同 | 不允许 |
| http://www.baidu.com/a.js </br> http://www.taobao.com/a.js | 主域相同，子域不同 | 不允许 |


## 跨域的解决方案

- 跨域资源共享（CORS）
- 通过JSONP跨域
- nginx代理跨域
- nodejs中间件代理跨域
- postMessage跨域
- document.domain + iframe跨域
- location.hash + iframe
- window.name + iframe跨域
- WebSocket协议跨域

---

# 跨域资源共享（CORS）

## **概念说明**
CORS（Cross-origin resource sharing）是一个W3C标准，全称是"跨域资源共享"，它是一种机制，通过使用使用**额外的HTTP头**来告诉浏览器，允许发出跨域的请求。

![](/images/crossOrigin.png)

## CORS 有以下特点

- 需要浏览器和服务器同时支持（低于IE10，需要做兼容）
- 整个过程浏览器自己完成，不需要用户参与
- 浏览器一旦发现请求跨域，会自动添加一些附加的头信息，有时还会多出一次附加的请求，但是用户不会有感觉

## 什么情况下需要CORS

- 由`XMLHttpRequest`或者`Fetch`发起的跨域HTTP请求
- 引用跨域的web字体
- 引用跨域的webgl贴图
- 使用`drawImage`将`Images/video`画面绘制到`canvas`上

## CORS和JSONP的区别

- `JSONP`只支持`GET`请求，`CORS`支持所有类型的`HTTP`请求
- `JSONP`的优势在于支持老式浏览器，比如IE10以下
- `JSONP`可以向不支持CORS的网站请求数据

## CORS简单请求

![](./../../images/simpleRequest.png)

- Access-Control-Allow-Origin

    要么是请求时的origin字段的值，要么是通配符`*`

- Access-Control-Allow-Credentials

    是否允许发送`Cookie`。除了服务器需要打开该字段，客户端也需要设置`XMLHttpRequest`的`withCredentials` 为true，否则就算服务器返回了cookie，下次客户端发起请求的时候浏览器也不会带上cookie。而且这个时候`Access-Control-Allow-Origin`也不能设为星号，必须指定明确的、与请求网页一致的域名。同时，Cookie依然遵循同源政策，只有用服务器域名设置的Cookie才会上传，其他域名的Cookie并不会上传，且（跨源）原网页代码中的document.cookie也无法读取服务器域名下的Cookie。

- Access-Control-Expose-Headers

    CORS请求时，`XMLHttpRequest`对象的`getResponseHeader()` 只能拿到6个基本字段，如果想要拿到别的字段就需要利用这个字段来指定。

## CORS预检请求

预检请求是指浏览器会在正式请求前自动先发送一个`OPTION`请求给服务器，它会询问当前网页所在的域名是否在服务器的许可名单之中、可以使用哪些HTTP动词和头信息字段，只有当服务器返回肯定答复之后它才会正式发出`XMLHttpRequest` 请求。它可以避免跨域请求时对服务器用户数据产生未预期的影响。

![](./../../images/preflightRequest.png.png)

- Access-Control-Allow-Headers

    预检请求中的，指定允许哪些头部字段出现在正式请求中。

- Access-Control-Max-Age

    该预检请求的有效期，在该时间段内再次请求，浏览器可以不再发送该预检请求

---

# JSONP


**参考资料：**

[MDN：HTTP访问控制（CORS）](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)

[阮一峰：跨域资源共享 CORS 详解](http://www.ruanyifeng.com/blog/2016/04/cors.html)

[http://www.cnblogs.com/dowinning/archive/2012/04/19/json-jsonp-jquery.html](http://www.cnblogs.com/dowinning/archive/2012/04/19/json-jsonp-jquery.html)